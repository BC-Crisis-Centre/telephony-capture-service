#!/bin/bash

PROGNAME=$(basename $0)

source ./scripts/bash-functions

postgres-rollback () {

	# If neither pg container is running, then try to bring the original back to life
	pg-status &> /dev/null

	if [ -z "$ACTIVE_PG" ]; then

		msg 'Switch Failed - Rolling Back to '$FROM_PG;

		# Remove the pg container whose startup failed
		remove-pg-container $TO_PG

		# Adjust the ports back to what they were
		set-pg-ports $FROM_PG
		
		if ! start-pg-container $FROM_PG; then
			msg 'Unable to restart the original container'; 
			msg 'WARNING: TCS is partially disabled';
			exit 1
		else
			msg $FROM_PG' Container Started'
		fi
		
		sleep 7
		if enable-stream-replication $FROM_PG; then 
			msg $FROM' Stream Replication Activated'; 
		else 
			msg $1' Stream Replication Failed to Activate'; 
		fi
	fi

	# Bring barman back
	if container-exists barman; then
		if start-container barman; then 
			msg 'barman Restarted'; 
		else 
			msg 'barman Restart Failed'; 
		fi
		sleep 2
		enable-barman-backups
	fi
	pg-status
}

# Load $ACTIVE_PG and $STANDBY_PG with the following
pg-status &> /dev/null

FROM_PG=$ACTIVE_PG
TO_PG=$STANDBY_PG

if [ -z ${ACTIVE_PG+x} ]; then error-exit 'No Active Postgres Container'; fi

msg 'Begin Postgres Container Switch from '$FROM_PG' to '$TO_PG;

# Do a final backup
if docker exec -it barman sh -c 'barman backup '$FROM_PG' 2>&1 >/dev/null; exit $?;'; then
	msg $FROM_PG' Final Backup Successful';
else
	# Abort if a final backup is not possible
	error-exit $FROM_PG' Final Backup Failed';
fi

# Ensure the target container is quiet
remove-pg-container $TO_PG

# Make barman quiet
stop-container barman

# Arrange for a possible rollback, if something goes amiss
trap postgres-rollback EXIT;

# Shutdown the outgoing container
remove-pg-container $FROM_PG

barman-recover-latest $FROM_PG $TO_PG

# Port mappings need to be modified
set-pg-ports $TO_PG
source ./.tcs-pg-ports

# Now start the incoming database container
if ! start-pg-container $TO_PG; then
	error-exit $TO_PG' Failed to Start Container';
fi

sleep 10;

# Ensure stream replication is enabled
if ! enable-stream-replication $TO_PG; then
	error-exit 'Failed to Enable Stream Replication';
fi

# Bring barman back
start-container barman
sleep 2
enable-barman-backups

trap '' EXIT;
msg 'Postgres Container Switch Successful'
pg-status
exit 0
