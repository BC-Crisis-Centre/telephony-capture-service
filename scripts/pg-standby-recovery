#!/bin/bash

PROGNAME=$(basename $0)
USAGE='Usage: '$PROGNAME' pg1|pg2 backup_id target_time'

source ./scripts/bash-functions
source ./.tcs-pg-ports

if [ "$#" != 3 ]; then error-exit "$USAGE"; fi

validate-pg-selection $1 "$USAGE"

validate-backup_id $1 $2

# Get the pg statuses (Active or PITR)
pg-status &> /dev/null

# Remove the STANDBY container, before doing the recovery
remove-pg-container $STANDBY_PG

# Do the recovery
barman-pitr $STANDBY_PG $1 $2 $3

# Finally bring up the STANDBY container to listen on port 5433
start-pg-container $STANDBY_PG; sleep 2;
enable-stream-replication $STANDBY_PG 5433 &> /dev/null

msg 'Standby Recovery to '$STANDBY_PG' Complete'
pg-status
exit 0
