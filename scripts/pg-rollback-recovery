#!/bin/bash

PROGNAME=$(basename $0)
USAGE='Usage: '$PROGNAME' pg1|pg2 backup_id [target_time]'

source ./scripts/bash-functions
source ./.tcs-pg-ports

if [ "$#" != 3 ]; then error-exit "$USAGE"; fi

validate-pg-selection $1 "$USAGE"

validate-backup_id $1 $2

# Make barman quiet
stop-container barman

# Get the statuses of the Postgres containers
pg-status &> /dev/null

# Shutdown the active Postgres container
remove-pg-container $ACTIVE_PG

# Do the recovery
barman-pitr $ACTIVE_PG $1 $2 $3

# Restart the container
start-pg-container $ACTIVE_PG; sleep 2; 
enable-stream-replication $ACTIVE_PG

# Bring barman back
start-container barman
sleep 2
enable-barman-backups

msg 'Rollback Recovery Complete'
pg-status
exit 0
